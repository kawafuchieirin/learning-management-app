{% extends "base.html" %}

{% block title %}è¨˜éŒ²è¿½åŠ  - å­¦ç¿’è¨˜éŒ²ç®¡ç†ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-plus"></i> å­¦ç¿’è¨˜éŒ²ã‚’è¿½åŠ </h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="date" class="form-label">æ—¥ä»˜ <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="time" class="form-label">å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰ <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="time" name="time" min="1" placeholder="ä¾‹: 60" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">å­¦ç¿’å†…å®¹ <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="content" name="content" rows="3" placeholder="ä¾‹: Pythonã®åŸºæœ¬æ–‡æ³•ã‚’å­¦ç¿’" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ <span class="text-danger">*</span></label>
                                <select class="form-control" id="category" name="category" required>
                                    <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                    <option value="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</option>
                                    <option value="æ•°å­¦">æ•°å­¦</option>
                                    <option value="è‹±èª">è‹±èª</option>
                                    <option value="è³‡æ ¼å‹‰å¼·">è³‡æ ¼å‹‰å¼·</option>
                                    <option value="èª­æ›¸">èª­æ›¸</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                                <small class="form-text text-muted">
                                    å­¦ç¿’å†…å®¹ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="roadmap_id" class="form-label">ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— <small class="text-muted">ï¼ˆä»»æ„ï¼‰</small></label>
                                <select class="form-control" id="roadmap_id" name="roadmap_id">
                                    <option value="">ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                                    {% for roadmap in roadmaps %}
                                        <option value="{{ roadmap.roadmap_id }}">{{ roadmap.title }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    ã“ã®å­¦ç¿’ãŒãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã®ä¸€éƒ¨ã®å ´åˆã¯é¸æŠã—ã¦ãã ã•ã„ã€‚
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="milestone-section" style="display: none;">
                        <label for="milestone_id" class="form-label">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ <small class="text-muted">ï¼ˆä»»æ„ï¼‰</small></label>
                        <select class="form-control" id="milestone_id" name="milestone_id">
                            <option value="">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                        </select>
                        <small class="form-text text-muted">
                            å…·ä½“çš„ã«ã©ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã«é–¢é€£ã™ã‚‹å­¦ç¿’ã‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                        </small>
                    </div>
                    
                    <!-- Memo Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-sticky-note"></i> ãƒ¡ãƒ¢æ©Ÿèƒ½ï¼ˆæŒ¯ã‚Šè¿”ã‚Šå­¦ç¿’ï¼‰</h6>
                            <small class="text-muted">ä»¥ä¸‹ã®é …ç›®ã¯ä»»æ„ã§ã™ã€‚å¾Œã‹ã‚‰æŒ¯ã‚Šè¿”ã‚Šã«æ´»ç”¨ã§ãã¾ã™ã€‚</small>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="understood" class="form-label">
                                    <i class="fas fa-lightbulb text-success"></i> ç†è§£ã§ããŸã“ã¨
                                    <small class="text-muted">ï¼ˆä»»æ„ï¼‰</small>
                                </label>
                                <textarea class="form-control" id="understood" name="understood" rows="3" 
                                          placeholder="ä¾‹: é–¢æ•°ã®åŸºæœ¬çš„ãªæ›¸ãæ–¹ãŒç†è§£ã§ããŸã€‚å¼•æ•°ã¨returnã®é–¢ä¿‚ãŒæ˜ç¢ºã«ãªã£ãŸã€‚"></textarea>
                                <small class="form-text text-muted">
                                    æ–°ã—ãç†è§£ã§ããŸã“ã¨ã‚„ã€ä»Šæ—¥ã®å­¦ç¿’ã§ã€Œãªã‚‹ã»ã©ï¼ã€ã¨æ€ã£ãŸã“ã¨ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="could_not_do" class="form-label">
                                    <i class="fas fa-exclamation-triangle text-warning"></i> ã§ããªã‹ã£ãŸã“ã¨
                                    <small class="text-muted">ï¼ˆä»»æ„ï¼‰</small>
                                </label>
                                <textarea class="form-control" id="could_not_do" name="could_not_do" rows="3" 
                                          placeholder="ä¾‹: ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãŒã¾ã ç†è§£ã§ãã¦ã„ãªã„ã€‚ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…ã§è©°ã¾ã£ãŸã€‚"></textarea>
                                <small class="form-text text-muted">
                                    ä»Šæ—¥ã§ããªã‹ã£ãŸã“ã¨ã‚„ã€æ¬¡å›ã«æŒã¡è¶Šã—ãŸã„èª²é¡Œã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> è¨˜éŒ²ã‚’ä¿å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Tips Section -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> ğŸ’¡ ãƒ¡ãƒ¢æ©Ÿèƒ½ã®æ´»ç”¨æ–¹æ³•</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success"><i class="fas fa-check-circle"></i> ç†è§£ã§ããŸã“ã¨</h6>
                        <ul class="small">
                            <li>æ–°ã—ãå­¦ã‚“ã æ¦‚å¿µã‚„æŠ€è¡“</li>
                            <li>ã€Œãªã‚‹ã»ã©ï¼ã€ã¨æ€ã£ãŸç¬é–“</li>
                            <li>å‰å›ç†è§£ã§ããªã‹ã£ãŸã“ã¨ãŒç†è§£ã§ããŸ</li>
                            <li>å®Ÿéš›ã«å‹•ãã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ãŸ</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> ã§ããªã‹ã£ãŸã“ã¨</h6>
                        <ul class="small">
                            <li>ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã§ããªã‹ã£ãŸ</li>
                            <li>ç†è§£ã«æ™‚é–“ãŒã‹ã‹ã£ãŸæ¦‚å¿µ</li>
                            <li>æ¬¡å›ã«æŒã¡è¶Šã—ãŸã„èª²é¡Œ</li>
                            <li>ã‚‚ã£ã¨æ·±ãå­¦ã³ãŸã„å†…å®¹</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Set today's date as default
    document.getElementById('date').valueAsDate = new Date();
    
    // Roadmap data for milestone loading
    const roadmapsData = {
        {% for roadmap in roadmaps %}
        "{{ roadmap.roadmap_id }}": {
            "title": "{{ roadmap.title }}",
            "milestones": [
                {% for milestone in roadmap.milestones %}
                {
                    "id": "{{ milestone.id }}",
                    "title": "{{ milestone.title }}",
                    "completed": {{ "true" if milestone.completed else "false" }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
    // Handle roadmap selection change
    document.getElementById('roadmap_id').addEventListener('change', function() {
        const roadmapId = this.value;
        const milestoneSection = document.getElementById('milestone-section');
        const milestoneSelect = document.getElementById('milestone_id');
        
        if (roadmapId && roadmapsData[roadmapId]) {
            // Show milestone section
            milestoneSection.style.display = 'block';
            
            // Clear and populate milestone options
            milestoneSelect.innerHTML = '<option value="">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>';
            
            roadmapsData[roadmapId].milestones.forEach(milestone => {
                const option = document.createElement('option');
                option.value = milestone.id;
                option.textContent = milestone.title + (milestone.completed ? ' âœ“' : '');
                milestoneSelect.appendChild(option);
            });
        } else {
            // Hide milestone section
            milestoneSection.style.display = 'none';
            milestoneSelect.innerHTML = '<option value="">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>';
        }
    });
    
    // Auto-save to localStorage
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input, textarea, select');
    
    inputs.forEach(input => {
        // Load saved values
        const savedValue = localStorage.getItem(`form_${input.name}`);
        if (savedValue && input.type !== 'date') {
            input.value = savedValue;
            // Trigger change event for roadmap selection
            if (input.name === 'roadmap_id') {
                input.dispatchEvent(new Event('change'));
            }
        }
        
        // Save on input
        input.addEventListener('input', () => {
            localStorage.setItem(`form_${input.name}`, input.value);
        });
        
        // Save on change for select elements
        input.addEventListener('change', () => {
            localStorage.setItem(`form_${input.name}`, input.value);
        });
    });
    
    // Clear localStorage on successful submit
    form.addEventListener('submit', () => {
        inputs.forEach(input => {
            localStorage.removeItem(`form_${input.name}`);
        });
    });
</script>
{% endblock %}