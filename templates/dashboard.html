{% extends "base.html" %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å­¦ç¿’è¨˜éŒ²ç®¡ç†ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<h1 class="mb-4">å­¦ç¿’ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

<!-- Motivational Message -->
<div class="alert alert-info mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
    <div class="d-flex align-items-center">
        <div class="me-3" style="font-size: 2rem;">ğŸ†</div>
        <div>
            <h5 class="mb-1" style="color: white;">ä»Šæ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h5>
            <p class="mb-0" style="font-size: 1.1rem;">{{ motivational_message }}</p>
        </div>
    </div>
</div>

<!-- Level and Experience -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border: none;">
            <div class="card-body">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ†</div>
                <h3 class="text-primary">Level {{ level_info.level }}</h3>
                <p class="mb-2">{{ level_info.experience }} XP</p>
                <div class="progress mb-2" style="height: 10px;">
                    <div class="progress-bar bg-warning" role="progressbar" 
                         style="width: {{ level_info.progress_percent }}%;"></div>
                </div>
                <small class="text-muted">{{ level_info.xp_current_level }}/{{ level_info.xp_for_next_level }} XP</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border: none;">
            <div class="card-body">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ”¥</div>
                <h3 class="text-danger">{{ streak }}æ—¥</h3>
                <p class="mb-0">é€£ç¶šå­¦ç¿’ã‚¹ãƒˆãƒªãƒ¼ã‚¯</p>
                {% if streak >= 7 %}
                    <small class="text-success">ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›ï¼</small>
                {% elif streak >= 3 %}
                    <small class="text-info">ã„ã„ãƒšãƒ¼ã‚¹ã§ã™ï¼</small>
                {% else %}
                    <small class="text-muted">æ¯æ—¥ã‚³ãƒ„ã‚³ãƒ„ã¨</small>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); border: none;">
            <div class="card-body">
                <h5 class="text-center mb-3">ğŸ… é”æˆãƒãƒƒã‚¸</h5>
                {% if badges %}
                    <div class="d-flex flex-wrap justify-content-center gap-2">
                        {% for badge in badges[:4] %}
                            <span class="badge bg-light text-dark p-2" style="border: 2px solid #007bff;" 
                                  title="{{ badge.description }}">
                                {{ badge.icon }} {{ badge.name }}
                            </span>
                        {% endfor %}
                        {% if badges|length > 4 %}
                            <span class="badge bg-secondary">+{{ badges|length - 4 }}</span>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-center text-muted mb-0">å­¦ç¿’ã§ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã‚ˆã†ï¼</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Main Stats -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-clock text-primary"></i> å­¦ç¿’æ™‚é–“</h5>
                <p class="mb-1">ä»Šé€±: <strong class="text-success">{{ week_total_time }} åˆ†</strong></p>
                <p class="mb-0">å…¨æœŸé–“: <strong class="text-info">{{ all_time_total }} åˆ†</strong> ({{ total_days }}æ—¥é–“)</p>
                <small class="text-muted">å¹³å‡: {{ avg_time_per_day }}åˆ†/æ—¥</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-lightbulb text-warning"></i> å­¦ç¿’æˆæœ</h5>
                <p class="mb-1">ç†è§£ã§ããŸã“ã¨: <strong class="text-success">{{ understood_items|length }} é …ç›®</strong></p>
                <p class="mb-0">æ”¹å–„ã™ã¹ãã“ã¨: <strong class="text-warning">{{ could_not_do_items|length }} é …ç›®</strong></p>
            </div>
        </div>
    </div>
</div>

<!-- Growth Chart -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> æˆé•·ã‚°ãƒ©ãƒ•ï¼ˆ30æ—¥é–“ï¼‰</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-8">
                <canvas id="growthChart" width="400" height="200"></canvas>
            </div>
            <div class="col-md-4">
                <div class="card bg-light h-100">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-lightbulb text-warning"></i> å­¦ç¿’ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h6>
                        {% if insights.best_day %}
                            <p class="mb-2"><strong>æœ€é«˜ã®æ›œæ—¥:</strong> {{ insights.best_day }}</p>
                        {% endif %}
                        <p class="mb-2"><strong>å¹³å‡ã‚»ãƒƒã‚·ãƒ§ãƒ³:</strong> {{ insights.avg_session }}åˆ†</p>
                        <p class="mb-2"><strong>ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°:</strong> {{ insights.total_sessions }}å›</p>
                        <div class="mb-0">
                            <strong>æœ€è¿‘ã®å‚¾å‘:</strong>
                            {% if insights.improvement_trend == 'improving' %}
                                <span class="badge bg-success"><i class="fas fa-arrow-up"></i> å‘ä¸Šä¸­</span>
                            {% elif insights.improvement_trend == 'declining' %}
                                <span class="badge bg-warning"><i class="fas fa-arrow-down"></i> ä½ä¸‹</span>
                            {% else %}
                                <span class="badge bg-info"><i class="fas fa-minus"></i> å®‰å®š</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> é’ç·š: æ—¥åˆ¥å­¦ç¿’æ™‚é–“ | ç·‘ç·š: ç´¯ç©å­¦ç¿’æ™‚é–“ | ã‚ªãƒ¬ãƒ³ã‚¸ç·š: 7æ—¥é–“å¹³å‡
            </small>
        </div>
    </div>
</div>

<!-- Recent Records -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-history"></i> æœ€è¿‘ã®å­¦ç¿’è¨˜éŒ²</h5>
    </div>
    <div class="card-body">
        {% if recent_records %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>å†…å®¹</th>
                            <th>æ™‚é–“</th>
                            <th>çŠ¶æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in recent_records[:5] %}
                            <tr>
                                <td>{{ record.date }}</td>
                                <td>{{ record.content }}</td>
                                <td><span class="badge bg-primary">{{ record.time }}åˆ†</span></td>
                                <td>
                                    {% if record.understood %}
                                        <i class="fas fa-check-circle text-success" title="ç†è§£ã§ããŸã“ã¨ã‚ã‚Š"></i>
                                    {% endif %}
                                    {% if record.could_not_do %}
                                        <i class="fas fa-exclamation-triangle text-warning" title="æ”¹å–„ç‚¹ã‚ã‚Š"></i>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{{ url_for('records') }}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> ã™ã¹ã¦ã®è¨˜éŒ²ã‚’è¦‹ã‚‹
            </a>
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-3">ã¾ã å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <a href="{{ url_for('add_record') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> æœ€åˆã®è¨˜éŒ²ã‚’ä½œæˆ
                </a>
            </div>
        {% endif %}
    </div>
</div>


<!-- Achievement Details Modal (triggered by clicking badges) -->
<div class="modal fade" id="achievementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ğŸ… é”æˆãƒãƒƒã‚¸ä¸€è¦§</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if badges %}
                    <div class="row g-3">
                        {% for badge in badges %}
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <div style="font-size: 2rem;">{{ badge.icon }}</div>
                                        <h6 class="card-title">{{ badge.name }}</h6>
                                        <p class="card-text small text-muted">{{ badge.description }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-muted">ã¾ã ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚å­¦ç¿’ã‚’ç¶šã‘ã¦ç‰¹åˆ¥ãªãƒãƒƒã‚¸ã‚’æ‰‹ã«å…¥ã‚Œã¾ã—ã‚‡ã†ï¼</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
.btn:hover {
    transform: translateY(-1px);
}
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart data from backend
const chartData = {
    labels: {{ chart_data.labels | tojson }},
    dailyTime: {{ chart_data.daily_time | tojson }},
    cumulativeTime: {{ chart_data.cumulative_time | tojson }},
    weeklyAverage: {{ chart_data.weekly_average | tojson }}
};

// Initialize Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('growthChart').getContext('2d');
    
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'æ—¥åˆ¥å­¦ç¿’æ™‚é–“(åˆ†)',
                    data: chartData.dailyTime,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'ç´¯ç©å­¦ç¿’æ™‚é–“(åˆ†)',
                    data: chartData.cumulativeTime,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    yAxisID: 'y1'
                },
                {
                    label: '7æ—¥é–“å¹³å‡(åˆ†)',
                    data: chartData.weeklyAverage,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.1,
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y + 'åˆ†';
                            if (context.parsed.y >= 60) {
                                const hours = Math.floor(context.parsed.y / 60);
                                const minutes = context.parsed.y % 60;
                                label += ` (${hours}æ™‚é–“${minutes > 0 ? minutes + 'åˆ†' : ''})`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ—¥ä»˜'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'æ—¥åˆ¥/å¹³å‡æ™‚é–“(åˆ†)'
                    },
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'ç´¯ç©æ™‚é–“(åˆ†)'
                    },
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
    
    // Add click event to badges to show modal
    const badgeContainer = document.querySelector('.badge');
    if (badgeContainer) {
        badgeContainer.closest('.card').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('achievementModal'));
            modal.show();
        });
    }
});
</script>
{% endblock %}